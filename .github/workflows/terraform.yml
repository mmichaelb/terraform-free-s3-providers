name: 'Terraform: Validate, lint and test'
on: [ push ]
jobs:
  terraform-validate-and-lint:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        provider: [ backblaze, cloudflare, oracle_cloud, scaleway ]
    env:
      working-directory: providers/${{ matrix.provider }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Install terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
      - run: terraform version
      - run: terraform init
        working-directory: ${{ env.working-directory }}
      - run: terraform validate
        working-directory: ${{ env.working-directory }}
      - name: Setup tflint
        uses: terraform-linters/setup-tflint@ae78205cfffec9e8d93fd2b3115c7e9d3166d4b6 # v5
        with:
          tflint_version: "latest"
      - run: tflint --version
      - run: tflint --recursive
        working-directory: ${{ env.working-directory }}
  terraform-tests:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        provider: [ backblaze, cloudflare, oracle_cloud, scaleway ]
    env:
      working-directory: providers/${{ matrix.provider }}/test
      terraform-workspace: test-${{ github.run_id }}
      SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Install terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
      - run: terraform version
      - run: terraform init
        working-directory: ${{ env.working-directory }}
      - run: terraform workspace new ${{ env.terraform-workspace }} || terraform workspace select ${{ env.terraform-workspace }}
        working-directory: ${{ env.working-directory }}
      - run: terraform plan
        working-directory: ${{ env.working-directory }}
      - run: terraform apply -auto-approve
        working-directory: ${{ env.working-directory }}
      - run: terraform destroy -auto-approve
        if: always()
        working-directory: ${{ env.working-directory }}
      - run: terraform workspace select default
        if: always()
        working-directory: ${{ env.working-directory }}
      - run: terraform workspace delete ${{ env.terraform-workspace }}
        if: always()
        working-directory: ${{ env.working-directory }}
